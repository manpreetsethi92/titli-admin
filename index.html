<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TITLI Command Center</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #fff; min-height: 100vh; }
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); }
    .login-box { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 360px; }
    .login-box h1 { font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 8px; }
    .login-box p { color: #888; font-size: 14px; text-align: center; margin-bottom: 24px; }
    .login-box input { width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #fff; font-size: 15px; outline: none; }
    .login-box button { width: 100%; padding: 14px; margin-top: 16px; background: #e63946; border: none; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #c92a36; }
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    header { padding: 16px 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #0a0a0f; z-index: 100; }
    .logo { font-size: 22px; font-weight: 800; color: #e63946; }
    .logo span { color: #666; font-size: 14px; font-weight: 400; margin-left: 8px; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .header-actions button { padding: 8px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; }
    .header-actions button:hover { background: rgba(255,255,255,0.15); }
    .header-actions .logout { background: transparent; color: #888; }
    .last-updated { font-size: 11px; color: #666; }
    .container { max-width: 1600px; margin: 0 auto; padding: 24px; }
    .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 32px; }
    @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    .stat-card { padding: 20px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card.blue { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.05)); border: 1px solid rgba(59,130,246,0.3); }
    .stat-card.purple { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.3); }
    .stat-card.yellow { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.05)); border: 1px solid rgba(245,158,11,0.3); }
    .stat-card.green { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.3); }
    .stat-card.red { background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.3); }
    .stat-card.orange { background: linear-gradient(135deg, rgba(249,115,22,0.2), rgba(249,115,22,0.05)); border: 1px solid rgba(249,115,22,0.3); }
    .stat-value { font-size: 32px; font-weight: 700; }
    .stat-label { font-size: 12px; color: #888; margin-top: 4px; text-transform: uppercase; }
    .stat-detail { font-size: 11px; color: #666; margin-top: 8px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: rgba(255,255,255,0.05); border: none; border-radius: 8px; color: #888; cursor: pointer; font-size: 14px; font-weight: 500; }
    .tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .tab.active { background: #e63946; color: #fff; }
    .tab .badge { margin-left: 8px; padding: 2px 8px; background: #f59e0b; border-radius: 10px; font-size: 11px; color: #000; }
    .toolbar { display: none; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .toolbar.active { display: flex; }
    .search { flex: 1; min-width: 200px; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 14px; outline: none; }
    .filter-select { padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 13px; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); font-weight: 600; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
    .card-header .count { font-size: 12px; color: #666; font-weight: 400; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }
    @media (max-width: 1024px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    .item-card { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; }
    .item-card:hover { background: rgba(255,255,255,0.03); }
    .item-card:last-child { border-bottom: none; }
    .item-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #e63946, #f97316); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 16px; flex-shrink: 0; }
    .item-info { flex: 1; }
    .item-name { font-weight: 600; font-size: 15px; }
    .item-sub { font-size: 12px; color: #666; }
    .item-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .skill-tag { padding: 4px 10px; background: rgba(139,92,246,0.15); color: #a78bfa; border-radius: 20px; font-size: 11px; }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; }
    .badge.green { background: rgba(16,185,129,0.15); color: #10b981; }
    .badge.yellow { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .badge.orange { background: rgba(249,115,22,0.15); color: #f97316; }
    .badge.red { background: rgba(239,68,68,0.15); color: #ef4444; }
    .badge.blue { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .badge.gray { background: rgba(128,128,128,0.15); color: #888; }
    .action-btn { padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 500; text-decoration: none; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 4px; }
    .action-btn:hover { opacity: 0.8; }
    .action-btn.primary { background: #e63946; color: #fff; }
    .action-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .action-btn.green { background: #10b981; color: #fff; }
    .action-btn.reddit { background: #ff4500; color: #fff; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal { background: #1a1a2e; border-radius: 16px; width: 100%; max-width: 700px; max-height: 85vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
    .modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a2e; }
    .modal-header h2 { font-size: 18px; font-weight: 600; }
    .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-section { margin-bottom: 20px; }
    .modal-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
    .modal-section p { font-size: 14px; line-height: 1.6; }
    .empty { padding: 40px 20px; text-align: center; color: #666; font-size: 14px; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .activity-item { padding: 12px 16px; border-left: 2px solid rgba(255,255,255,0.1); margin-left: 10px; position: relative; }
    .activity-item::before { content: ''; width: 8px; height: 8px; background: #e63946; border-radius: 50%; position: absolute; left: -5px; top: 16px; }
    .activity-item.green::before { background: #10b981; }
    .activity-item.blue::before { background: #3b82f6; }
    .activity-text { font-size: 13px; }
    .activity-time { font-size: 11px; color: #666; margin-top: 4px; }
    .funnel-item { padding: 12px 20px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .funnel-bar { flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
    .funnel-fill { height: 100%; background: linear-gradient(90deg, #e63946, #f97316); }
    .funnel-label { width: 120px; font-size: 13px; }
    .funnel-value { width: 60px; text-align: right; font-weight: 600; }
    .job-card { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .job-card:hover { background: rgba(255,255,255,0.02); }
    .job-card:last-child { border-bottom: none; }
    .job-title { font-weight: 600; font-size: 16px; margin-bottom: 8px; cursor: pointer; }
    .job-title:hover { color: #f97316; }
    .job-meta { display: flex; gap: 16px; font-size: 13px; color: #888; margin-bottom: 12px; flex-wrap: wrap; }
    .job-meta a { color: #3b82f6; text-decoration: none; }
    .job-meta a:hover { text-decoration: underline; }
    .job-skills { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
    .job-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .outreach-template { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; font-size: 12px; color: #ccc; margin-top: 12px; position: relative; white-space: pre-wrap; }
    .copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 10px; }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <form class="login-box" onsubmit="handleLogin(event)">
      <h1>TITLI</h1>
      <p>Command Center</p>
      <input type="password" id="password" placeholder="Enter password" required>
      <button type="submit">Enter</button>
    </form>
  </div>
  
  <div class="dashboard" id="dashboard">
    <header>
      <div><span class="logo">TITLI<span>Command Center</span></span></div>
      <div class="header-actions">
        <span class="last-updated" id="lastUpdated"></span>
        <button onclick="fetchAllData()">Refresh</button>
        <button class="logout" onclick="logout()">Logout</button>
      </div>
    </header>
    
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card blue" onclick="switchTab('users')"><div class="stat-value" id="statUsers">0</div><div class="stat-label">Users</div><div class="stat-detail" id="statUsersDetail">-</div></div>
        <div class="stat-card green" onclick="switchTab('connections')"><div class="stat-value" id="statConnections">0</div><div class="stat-label">Connections</div><div class="stat-detail">Matches</div></div>
        <div class="stat-card purple" onclick="switchTab('requests')"><div class="stat-value" id="statRequests">0</div><div class="stat-label">Requests</div><div class="stat-detail" id="statRequestsDetail">-</div></div>
        <div class="stat-card yellow" onclick="switchTab('unfilled')"><div class="stat-value" id="statUnfilled">0</div><div class="stat-label">Unfilled</div><div class="stat-detail">Need matches</div></div>
        <div class="stat-card orange" onclick="switchTab('external-jobs')"><div class="stat-value" id="statExternalJobs">0</div><div class="stat-label">External Jobs</div><div class="stat-detail" id="statExternalJobsDetail">Reddit</div></div>
        <div class="stat-card red" onclick="switchTab('activity')"><div class="stat-value" id="statActivity">0</div><div class="stat-label">Today</div><div class="stat-detail">Activity</div></div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="activity">Activity</button>
        <button class="tab" data-tab="users">Users</button>
        <button class="tab" data-tab="requests">Requests</button>
        <button class="tab" data-tab="unfilled">Unfilled <span class="badge" id="unfilledBadge">0</span></button>
        <button class="tab" data-tab="connections">Connections</button>
        <button class="tab" data-tab="external-jobs">External Jobs <span class="badge" id="externalJobsBadge" style="background:#f97316;">0</span></button>
        <button class="tab" data-tab="analytics">Analytics</button>
      </div>
      
      <div class="toolbar" id="toolbar-users">
        <input type="text" class="search" placeholder="Search users..." oninput="handleUserSearch(this.value)">
        <select class="filter-select" onchange="handleUserStatusFilter(this.value)">
          <option value="active">Active</option>
          <option value="all">All</option>
          <option value="blacklisted">Blacklisted</option>
        </select>
      </div>
      
      <div class="toolbar" id="toolbar-external-jobs">
        <input type="text" class="search" placeholder="Search jobs by title, skills, subreddit..." oninput="handleJobSearch(this.value)">
        <select class="filter-select" onchange="handleJobStatusFilter(this.value)">
          <option value="all">All Jobs</option>
          <option value="new">New</option>
          <option value="reviewed">Reviewed</option>
          <option value="contacted">Contacted</option>
        </select>
        <select class="filter-select" onchange="handleJobSort(this.value)">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="skills">Has Skills</option>
        </select>
      </div>
      
      <div class="tab-content active" id="tab-overview">
        <div class="grid-3">
          <div class="card"><div class="card-header">Recent Activity</div><div id="recentActivity"><div class="loading">Loading...</div></div></div>
          <div class="card" style="border-color:rgba(245,158,11,0.3);"><div class="card-header" style="color:#f59e0b;">Needs Attention</div><div id="needsAttention"><div class="loading">Loading...</div></div></div>
          <div class="card" style="border-color:rgba(249,115,22,0.3);"><div class="card-header" style="color:#f97316;">Latest Jobs</div><div id="recentJobs"><div class="loading">Loading...</div></div></div>
        </div>
        <div class="grid-2">
          <div class="card"><div class="card-header">Recent Users <span class="count" id="recentUsersCount">0</span></div><div id="recentUsers"><div class="loading">Loading...</div></div></div>
          <div class="card"><div class="card-header">Funnel</div><div id="quickFunnel"><div class="loading">Loading...</div></div></div>
        </div>
      </div>
      
      <div class="tab-content" id="tab-activity"><div class="card"><div class="card-header">Activity <span class="count" id="activityCount">0</span></div><div id="allActivity"><div class="loading">Loading...</div></div></div></div>
      <div class="tab-content" id="tab-users"><div class="card"><div class="card-header">Users <span class="count" id="userCount">0</span></div><div id="allUsers"><div class="loading">Loading...</div></div></div></div>
      <div class="tab-content" id="tab-requests"><div class="card"><div class="card-header">Requests <span class="count" id="requestCount">0</span></div><div id="allRequests"><div class="loading">Loading...</div></div></div></div>
      <div class="tab-content" id="tab-unfilled"><div class="card" style="border-color:rgba(245,158,11,0.3);"><div class="card-header" style="color:#f59e0b;">Unfilled Requests</div><div id="allUnfilled"><div class="loading">Loading...</div></div></div></div>
      <div class="tab-content" id="tab-connections"><div class="card" style="border-color:rgba(16,185,129,0.3);"><div class="card-header" style="color:#10b981;">Connections <span class="count" id="connectionCount">0</span></div><div id="allConnections"><div class="loading">Loading...</div></div></div></div>
      <div class="tab-content" id="tab-external-jobs"><div class="card" style="border-color:rgba(249,115,22,0.3);"><div class="card-header" style="color:#f97316;">External Jobs <span class="count" id="externalJobsCount">0</span></div><div id="allExternalJobs"><div class="loading">Loading...</div></div></div></div>
      <div class="tab-content" id="tab-analytics"><div class="grid-2"><div class="card"><div class="card-header">Funnel</div><div id="funnelChart"><div class="loading">Loading...</div></div></div><div class="card"><div class="card-header">Growth</div><div id="growthChart"><div class="loading">Loading...</div></div></div></div></div>
    </div>
  </div>
  
  <div class="modal-overlay" id="userModal"><div class="modal"><div class="modal-header"><h2 id="modalUserName">User</h2><button class="modal-close" onclick="closeModal('userModal')">&times;</button></div><div class="modal-body" id="modalUserBody"></div></div></div>
  <div class="modal-overlay" id="jobModal"><div class="modal"><div class="modal-header"><h2 id="modalJobTitle">Job</h2><button class="modal-close" onclick="closeModal('jobModal')">&times;</button></div><div class="modal-body" id="modalJobBody"></div></div></div>

  <script>
    const API = "https://titly-backend-production.up.railway.app/api";
    const PASSWORD = "titli2024";
    let users = [], requests = [], unfilled = [], connections = [], activity = [], externalJobs = [];
    let funnel = {}, growth = {};
    let userSearch = "", userStatusFilter = "active", jobSearch = "", jobStatusFilter = "all", jobSort = "newest";
    
    if (localStorage.getItem("titli_admin") === "true") { showDashboard(); fetchAllData(); setInterval(fetchAllData, 30000); const h = window.location.hash.replace('#', ''); if (h) switchTab(h); }
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.toolbar').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
        const tb = document.getElementById(`toolbar-${tab.dataset.tab}`);
        if (tb) tb.classList.add('active');
        window.location.hash = tab.dataset.tab;
      });
    });
    
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.toolbar').forEach(t => t.classList.remove('active'));
      const el = document.querySelector(`[data-tab="${tabId}"]`);
      if (el) { el.classList.add('active'); document.getElementById(`tab-${tabId}`).classList.add('active'); const tb = document.getElementById(`toolbar-${tabId}`); if (tb) tb.classList.add('active'); window.location.hash = tabId; }
    }
    
    function handleLogin(e) { e.preventDefault(); if (document.getElementById("password").value === PASSWORD) { localStorage.setItem("titli_admin", "true"); showDashboard(); fetchAllData(); setInterval(fetchAllData, 30000); } else alert("Wrong password"); }
    function logout() { localStorage.removeItem("titli_admin"); location.reload(); }
    function showDashboard() { document.getElementById("loginScreen").style.display = "none"; document.getElementById("dashboard").classList.add("active"); }
    
    async function fetchAllData() {
      try {
        const [u, r, uf, c, a, ej, f, g] = await Promise.all([
          fetch(`${API}/admin/users`).then(r => r.json()).catch(() => []),
          fetch(`${API}/admin/requests`).then(r => r.json()).catch(() => []),
          fetch(`${API}/admin/unfilled-requests`).then(r => r.json()).catch(() => []),
          fetch(`${API}/admin/connections`).then(r => r.json()).catch(() => []),
          fetch(`${API}/admin/activity?limit=100`).then(r => r.json()).catch(() => []),
          fetch(`https://titly-backend-production.up.railway.app/admin/external-jobs`).then(r => r.json()).catch(() => ({jobs: []})),
          fetch(`${API}/admin/analytics/funnel`).then(r => r.json()).catch(() => ({})),
          fetch(`${API}/admin/analytics/growth`).then(r => r.json()).catch(() => ({}))
        ]);
        users = u || []; requests = r || []; unfilled = uf || []; connections = c || [];
        activity = a || []; externalJobs = ej?.jobs || []; funnel = f || {}; growth = g || {};
        updateStats(); render();
        document.getElementById("lastUpdated").textContent = `Updated: ${new Date().toLocaleTimeString()}`;
      } catch (e) { console.error(e); }
    }
    
    function updateStats() {
      const tg = users.filter(u => u.telegram_connected).length;
      const today = activity.filter(a => new Date(a.timestamp).toDateString() === new Date().toDateString()).length;
      const newJobs = externalJobs.filter(j => j.status === 'new').length;
      const withSkills = externalJobs.filter(j => j.skills_needed?.length > 0).length;
      document.getElementById("statUsers").textContent = users.length;
      document.getElementById("statUsersDetail").textContent = `${tg} on TG`;
      document.getElementById("statConnections").textContent = connections.length;
      document.getElementById("statRequests").textContent = requests.length;
      document.getElementById("statRequestsDetail").textContent = `${requests.filter(r => r.status === 'completed').length} done`;
      document.getElementById("statUnfilled").textContent = unfilled.length;
      document.getElementById("statExternalJobs").textContent = externalJobs.length;
      document.getElementById("statExternalJobsDetail").textContent = `${newJobs} new`;
      document.getElementById("statActivity").textContent = today;
      document.getElementById("unfilledBadge").textContent = unfilled.length;
      document.getElementById("externalJobsBadge").textContent = newJobs;
    }
    
    function handleUserSearch(v) { userSearch = v.toLowerCase(); render(); }
    function handleUserStatusFilter(v) { userStatusFilter = v; render(); }
    function handleJobSearch(v) { jobSearch = v.toLowerCase(); render(); }
    function handleJobStatusFilter(v) { jobStatusFilter = v; render(); }
    function handleJobSort(v) { jobSort = v; render(); }
    
    function getFilteredUsers() { return users.filter(u => { const ms = !userSearch || u.name?.toLowerCase().includes(userSearch) || u.skills?.some(s => s.toLowerCase().includes(userSearch)); let mf = true; if (userStatusFilter === 'active') mf = !u.blacklisted; else if (userStatusFilter === 'blacklisted') mf = u.blacklisted; return ms && mf; }); }
    function getFilteredJobs() { let f = externalJobs.filter(j => { const ms = !jobSearch || j.title?.toLowerCase().includes(jobSearch) || j.subreddit?.toLowerCase().includes(jobSearch) || j.skills_needed?.some(s => s.toLowerCase().includes(jobSearch)); let mf = jobStatusFilter === 'all' || j.status === jobStatusFilter; return ms && mf; }); if (jobSort === 'newest') f.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); else if (jobSort === 'oldest') f.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)); else if (jobSort === 'skills') f.sort((a, b) => (b.skills_needed?.length || 0) - (a.skills_needed?.length || 0)); return f; }
    
    function render() {
      const fu = getFilteredUsers(), fj = getFilteredJobs();
      document.getElementById("recentActivity").innerHTML = activity.length === 0 ? '<div class="empty">No activity</div>' : activity.slice(0, 5).map(a => activityItem(a)).join("");
      document.getElementById("needsAttention").innerHTML = unfilled.length === 0 ? '<div class="empty">All good!</div>' : unfilled.slice(0, 4).map(r => `<div class="item-card"><div class="item-name" style="color:#fbbf24">${r.title}</div><div class="item-sub">${timeAgo(r.created_at)}</div></div>`).join("");
      document.getElementById("recentJobs").innerHTML = externalJobs.length === 0 ? '<div class="empty">No jobs</div>' : externalJobs.slice(0, 4).map(j => `<div class="item-card" onclick="showJobDetail('${j.id}')"><div class="item-name">${(j.title||'').substring(0,40)}...</div><div class="item-sub">r/${j.subreddit} ‚Ä¢ ${timeAgo(j.created_at)}</div></div>`).join("");
      document.getElementById("recentUsersCount").textContent = users.length;
      document.getElementById("recentUsers").innerHTML = users.length === 0 ? '<div class="empty">No users</div>' : users.slice(0, 4).map(u => userCard(u)).join("");
      if (funnel.funnel) document.getElementById("quickFunnel").innerHTML = funnel.funnel.slice(0, 4).map(f => `<div class="funnel-item"><div class="funnel-label">${f.stage}</div><div class="funnel-bar"><div class="funnel-fill" style="width:${f.percentage}%"></div></div><div class="funnel-value">${f.count}</div></div>`).join("");
      document.getElementById("activityCount").textContent = activity.length;
      document.getElementById("allActivity").innerHTML = activity.length === 0 ? '<div class="empty">No activity</div>' : activity.map(a => activityItem(a)).join("");
      document.getElementById("userCount").textContent = fu.length;
      document.getElementById("allUsers").innerHTML = fu.length === 0 ? '<div class="empty">No users</div>' : fu.map(u => userCard(u, true)).join("");
      document.getElementById("requestCount").textContent = requests.length;
      document.getElementById("allRequests").innerHTML = requests.length === 0 ? '<div class="empty">No requests</div>' : requests.map(r => `<div class="item-card"><div class="item-name">${r.title}</div><div class="item-sub">${timeAgo(r.created_at)}</div></div>`).join("");
      document.getElementById("allUnfilled").innerHTML = unfilled.length === 0 ? '<div class="empty">All filled!</div>' : unfilled.map(r => `<div class="item-card"><div class="item-name" style="color:#fbbf24">${r.title}</div><div class="item-sub">${timeAgo(r.created_at)}</div></div>`).join("");
      document.getElementById("connectionCount").textContent = connections.length;
      document.getElementById("allConnections").innerHTML = connections.length === 0 ? '<div class="empty">No connections</div>' : connections.map(c => `<div class="item-card"><div class="item-name">${c.user_1?.name || '?'} ‚Üî ${c.user_2?.name || '?'}</div><div class="item-sub">${timeAgo(c.created_at)}</div></div>`).join("");
      document.getElementById("externalJobsCount").textContent = `${fj.length} jobs`;
      document.getElementById("allExternalJobs").innerHTML = fj.length === 0 ? '<div class="empty">No jobs</div>' : fj.map(j => jobCard(j)).join("");
      if (funnel.funnel) document.getElementById("funnelChart").innerHTML = funnel.funnel.map(f => `<div class="funnel-item"><div class="funnel-label">${f.stage}</div><div class="funnel-bar"><div class="funnel-fill" style="width:${f.percentage}%"></div></div><div class="funnel-value">${f.count}</div></div>`).join("");
      if (growth.totals) document.getElementById("growthChart").innerHTML = `<div style="padding:20px;display:flex;justify-content:space-around;text-align:center"><div><div style="font-size:28px;font-weight:700;color:#3b82f6">${growth.totals.users}</div><div style="font-size:11px;color:#888">Users</div></div><div><div style="font-size:28px;font-weight:700;color:#8b5cf6">${growth.totals.requests}</div><div style="font-size:11px;color:#888">Requests</div></div><div><div style="font-size:28px;font-weight:700;color:#10b981">${growth.totals.connections}</div><div style="font-size:11px;color:#888">Connections</div></div></div>`;
    }
    
    function activityItem(a) { const colors = { 'user_signup': 'blue', 'profile_completed': 'green', 'telegram_connected': 'blue', 'request_created': 'purple', 'connection_made': 'green' }; const icons = { 'user_signup': 'üë§', 'profile_completed': '‚úì', 'telegram_connected': 'üì±', 'request_created': 'üìã', 'connection_made': 'ü§ù' }; let t = a.action.replace(/_/g, ' '); if (a.details?.name) t += `: ${a.details.name}`; return `<div class="activity-item ${colors[a.action] || ''}"><div class="activity-text">${icons[a.action] || '‚Ä¢'} ${t}</div><div class="activity-time">${timeAgo(a.timestamp)}</div></div>`; }
    function userCard(u, d = false) { return `<div class="item-card" onclick="showUserDetail('${u.id}')" ${u.blacklisted ? 'style="opacity:0.5"' : ''}><div class="item-header"><div class="avatar">${u.name?.charAt(0) || "?"}</div><div class="item-info"><div class="item-name">${u.name || "?"} ${u.blacklisted ? '<span class="badge red">‚õî</span>' : ''}</div><div class="item-sub">${u.phone || ""} ${u.location ? `‚Ä¢ ${u.location}` : ''}</div></div>${u.telegram_connected ? '<span class="badge green">TG</span>' : ''}</div><div class="item-meta">${(u.skills || []).slice(0, d ? 5 : 3).map(s => `<span class="skill-tag">${s}</span>`).join("")}</div></div>`; }
    function jobCard(j) { const sc = { 'new': 'orange', 'reviewed': 'blue', 'contacted': 'yellow', 'converted': 'green' }; const hs = j.skills_needed?.length > 0; return `<div class="job-card"><div style="display:flex;justify-content:space-between;align-items:start;"><div style="flex:1;"><div class="job-title" onclick="showJobDetail('${j.id}')">${j.title || 'Untitled'}</div><div class="job-meta"><span>r/<a href="https://reddit.com/r/${j.subreddit}" target="_blank">${j.subreddit || '?'}</a></span><span>by <a href="https://reddit.com/user/${j.reddit_author}" target="_blank">u/${j.reddit_author || '?'}</a></span><span>${timeAgo(j.created_at)}</span>${j.location ? `<span>üìç ${j.location}</span>` : ''}${j.budget_range ? `<span>üí∞ ${j.budget_range}</span>` : ''}</div></div><span class="badge ${sc[j.status] || 'gray'}">${j.status || 'new'}</span></div>${hs ? `<div class="job-skills">${j.skills_needed.map(s => `<span class="skill-tag">${s}</span>`).join('')}</div>` : '<div style="font-size:11px;color:#666;margin:8px 0;">‚ö†Ô∏è No skills extracted</div>'}<div class="job-actions">${j.reddit_url ? `<a href="${j.reddit_url}" target="_blank" class="action-btn reddit">View on Reddit ‚Üí</a>` : ''}<button class="action-btn secondary" onclick="showJobDetail('${j.id}')">Details</button><button class="action-btn secondary" onclick="copyOutreach('${j.id}')">üìã Copy Outreach</button>${j.status === 'new' ? `<button class="action-btn green" onclick="updateJobStatus('${j.id}', 'reviewed')">‚úì Reviewed</button>` : ''}</div></div>`; }
    
    function showJobDetail(id) { const j = externalJobs.find(x => x.id === id); if (!j) return; document.getElementById("modalJobTitle").textContent = j.title || "Job"; const mu = findMatchingUsers(j.skills_needed || []); const om = generateOutreach(j); document.getElementById("modalJobBody").innerHTML = `<div class="modal-section"><h3>Source</h3><p><strong>Subreddit:</strong> <a href="https://reddit.com/r/${j.subreddit}" target="_blank" style="color:#ff4500;">r/${j.subreddit}</a><br><strong>Posted by:</strong> <a href="https://reddit.com/user/${j.reddit_author}" target="_blank" style="color:#3b82f6;">u/${j.reddit_author}</a><br><strong>Posted:</strong> ${timeAgo(j.created_at)}<br>${j.reddit_url ? `<a href="${j.reddit_url}" target="_blank" class="action-btn reddit" style="margin-top:8px;">View Original Post ‚Üí</a>` : ''}</p></div><div class="modal-section"><h3>Full Post</h3><p style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;max-height:200px;overflow-y:auto;font-size:13px;">${j.original_text || 'No content'}</p></div><div class="modal-section"><h3>Extracted Info</h3><p><strong>Skills:</strong> ${j.skills_needed?.length ? j.skills_needed.map(s => `<span class="skill-tag">${s}</span>`).join(' ') : '<span style="color:#666">None</span>'}<br><br><strong>Location:</strong> ${j.location || '-'} | <strong>Budget:</strong> ${j.budget_range || '-'} | <strong>Urgency:</strong> ${j.urgency || '-'} | <strong>Type:</strong> ${j.project_type || '-'}</p></div>${mu.length > 0 ? `<div class="modal-section"><h3>Matching Titli Users (${mu.length})</h3><div style="display:flex;flex-wrap:wrap;gap:8px;">${mu.map(u => `<div style="background:rgba(16,185,129,0.15);padding:8px 12px;border-radius:8px;"><strong>${u.name}</strong><br><span style="font-size:11px;color:#888;">${u.matchingSkills.join(', ')}</span></div>`).join('')}</div></div>` : ''}<div class="modal-section"><h3>Outreach Template</h3><div class="outreach-template"><button class="action-btn secondary copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('om').innerText);this.textContent='Copied!'">Copy</button><div id="om">${om}</div></div></div><div class="modal-section"><h3>Actions</h3><div style="display:flex;gap:8px;"><button class="action-btn secondary" onclick="updateJobStatus('${j.id}','reviewed');closeModal('jobModal')">Mark Reviewed</button><button class="action-btn green" onclick="updateJobStatus('${j.id}','contacted');closeModal('jobModal')">Mark Contacted</button></div></div>`; document.getElementById("jobModal").classList.add("active"); }
    function findMatchingUsers(skills) { if (!skills?.length) return []; const ns = skills.map(s => s.toLowerCase()); return users.filter(u => { const us = (u.skills || []).map(s => s.toLowerCase()); const m = ns.filter(s => us.some(x => x.includes(s) || s.includes(x))); if (m.length) { u.matchingSkills = m; return true; } return false; }).slice(0, 5); }
    function generateOutreach(j) { return `Hey! I saw your post on r/${j.subreddit} about "${(j.title||'').substring(0,40)}..."\n\nI run Titli - a network connecting filmmakers and creative professionals. We have talented ${j.skills_needed?.slice(0,2).join(' & ') || 'creatives'} who might be perfect for your project.\n\nWould you like me to connect you? It's free!\n\nCheck us out: titli.app`; }
    function copyOutreach(id) { const j = externalJobs.find(x => x.id === id); if (!j) return; navigator.clipboard.writeText(generateOutreach(j)); alert('Copied!'); }
    async function updateJobStatus(id, s) { await fetch(`https://titly-backend-production.up.railway.app/admin/external-jobs/${id}?status=${s}`, { method: 'PATCH' }); fetchAllData(); }
    function showUserDetail(id) { const u = users.find(x => x.id === id); if (!u) return; document.getElementById("modalUserName").textContent = u.name || "User"; document.getElementById("modalUserBody").innerHTML = `<div class="modal-section"><h3>Contact</h3><p>üì± ${u.phone || '-'}<br>üìç ${u.location || '-'}<br>${u.telegram_connected ? '‚úÖ Telegram' : '‚ùå No Telegram'}</p></div><div class="modal-section"><h3>Bio</h3><p>${u.bio || '-'}</p></div><div class="modal-section"><h3>Skills</h3><div style="display:flex;gap:6px;flex-wrap:wrap">${(u.skills || []).map(s => `<span class="skill-tag">${s}</span>`).join('') || '-'}</div></div>`; document.getElementById("userModal").classList.add("active"); }
    function closeModal(id) { document.getElementById(id).classList.remove("active"); }
    function timeAgo(d) { if (!d) return ''; const s = Math.floor((new Date() - new Date(d)) / 1000); if (s < 60) return 'now'; if (s < 3600) return `${Math.floor(s / 60)}m`; if (s < 86400) return `${Math.floor(s / 3600)}h`; if (s < 604800) return `${Math.floor(s / 86400)}d`; return new Date(d).toLocaleDateString(); }
    document.getElementById("userModal").addEventListener("click", function(e) { if (e.target === this) closeModal('userModal'); });
    document.getElementById("jobModal").addEventListener("click", function(e) { if (e.target === this) closeModal('jobModal'); });
  </script>
</body>
</html>
