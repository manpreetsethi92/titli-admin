<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TITLI Command Center</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #fff;
      min-height: 100vh;
    }
    
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
    }
    .login-box {
      background: rgba(255,255,255,0.05);
      padding: 40px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      width: 100%;
      max-width: 360px;
    }
    .login-box h1 { font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 8px; }
    .login-box p { color: #888; font-size: 14px; text-align: center; margin-bottom: 24px; }
    .login-box input {
      width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 10px;
      color: #fff; font-size: 15px; outline: none;
    }
    .login-box button {
      width: 100%; padding: 14px; margin-top: 16px; background: #e63946;
      border: none; border-radius: 10px; color: #fff; font-size: 15px;
      font-weight: 600; cursor: pointer;
    }
    .login-box button:hover { background: #c92a36; }
    
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    
    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #0a0a0f;
      z-index: 100;
    }
    .logo { font-size: 22px; font-weight: 800; color: #e63946; }
    .logo span { color: #666; font-size: 14px; font-weight: 400; margin-left: 8px; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .header-actions button {
      padding: 8px 16px; background: rgba(255,255,255,0.1); border: none;
      border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px;
    }
    .header-actions button:hover { background: rgba(255,255,255,0.15); }
    .header-actions .logout { background: transparent; color: #888; }
    .last-updated { font-size: 11px; color: #666; }
    
    .container { max-width: 1600px; margin: 0 auto; padding: 24px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    
    .stat-card {
      padding: 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .stat-card.blue { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.05)); border: 1px solid rgba(59,130,246,0.3); }
    .stat-card.purple { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.3); }
    .stat-card.yellow { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.05)); border: 1px solid rgba(245,158,11,0.3); }
    .stat-card.green { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.3); }
    .stat-card.red { background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.3); }
    .stat-card.cyan { background: linear-gradient(135deg, rgba(6,182,212,0.2), rgba(6,182,212,0.05)); border: 1px solid rgba(6,182,212,0.3); }
    .stat-value { font-size: 32px; font-weight: 700; }
    .stat-label { font-size: 12px; color: #888; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-detail { font-size: 11px; color: #666; margin-top: 8px; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .tab {
      padding: 10px 20px; background: rgba(255,255,255,0.05); border: none;
      border-radius: 8px; color: #888; cursor: pointer; font-size: 14px; font-weight: 500;
      transition: all 0.2s;
    }
    .tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .tab.active { background: #e63946; color: #fff; }
    .tab .badge {
      margin-left: 8px; padding: 2px 8px; background: #f59e0b;
      border-radius: 10px; font-size: 11px; color: #000;
    }
    
    .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .search {
      flex: 1; min-width: 200px; padding: 12px 16px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px; color: #fff; font-size: 14px; outline: none;
    }
    .filter-btn {
      padding: 12px 20px; background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
      color: #888; cursor: pointer; font-size: 13px;
    }
    .filter-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .filter-btn.active { background: rgba(230,57,70,0.2); border-color: #e63946; color: #e63946; }
    
    .card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .card.highlight { border-color: rgba(245,158,11,0.3); }
    .card.success { border-color: rgba(16,185,129,0.3); }
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card.highlight .card-header { color: #f59e0b; }
    .card-header .count { font-size: 12px; color: #666; font-weight: 400; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }
    @media (max-width: 1024px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    
    .item-card {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      cursor: pointer;
      transition: background 0.2s;
    }
    .item-card:hover { background: rgba(255,255,255,0.03); }
    .item-card:last-child { border-bottom: none; }
    .item-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, #e63946, #f97316);
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 16px; flex-shrink: 0;
    }
    .item-info { flex: 1; }
    .item-name { font-weight: 600; font-size: 15px; }
    .item-sub { font-size: 12px; color: #666; }
    .item-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .skill-tag {
      padding: 4px 10px; background: rgba(139,92,246,0.15);
      color: #a78bfa; border-radius: 20px; font-size: 11px;
    }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; }
    .badge.green { background: rgba(16,185,129,0.15); color: #10b981; }
    .badge.yellow { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .badge.purple { background: rgba(139,92,246,0.15); color: #8b5cf6; }
    .badge.red { background: rgba(239,68,68,0.15); color: #ef4444; }
    .badge.blue { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .badge.gray { background: rgba(128,128,128,0.15); color: #888; }
    .badge.cyan { background: rgba(6,182,212,0.15); color: #06b6d4; }
    
    .action-btn {
      padding: 8px 14px; border-radius: 8px; font-size: 12px;
      font-weight: 500; text-decoration: none; cursor: pointer; border: none;
      transition: opacity 0.2s;
    }
    .action-btn:hover { opacity: 0.8; }
    .action-btn.ig { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); color: #fff; }
    .action-btn.li { background: #0a66c2; color: #fff; }
    .action-btn.primary { background: #e63946; color: #fff; }
    .action-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .action-btn.green { background: #10b981; color: #fff; }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #1a1a2e;
      border-radius: 16px;
      width: 100%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #1a1a2e;
    }
    .modal-header h2 { font-size: 18px; font-weight: 600; }
    .modal-close {
      background: none; border: none; color: #888;
      font-size: 24px; cursor: pointer; line-height: 1;
    }
    .modal-body { padding: 20px; }
    .modal-section { margin-bottom: 20px; }
    .modal-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
    .modal-section p { font-size: 14px; line-height: 1.6; }
    
    .form-row { margin-bottom: 12px; }
    .form-row label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
    .form-row input, .form-row select, .form-row textarea {
      width: 100%; padding: 10px 14px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px; color: #fff; font-size: 14px;
    }
    .form-row textarea { min-height: 80px; resize: vertical; }
    .form-inline { display: flex; gap: 12px; }
    .form-inline .form-row { flex: 1; }
    
    .empty { padding: 40px 20px; text-align: center; color: #666; font-size: 14px; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .activity-item {
      padding: 12px 16px;
      border-left: 2px solid rgba(255,255,255,0.1);
      margin-left: 10px;
      position: relative;
    }
    .activity-item::before {
      content: '';
      width: 8px; height: 8px;
      background: #e63946;
      border-radius: 50%;
      position: absolute;
      left: -5px;
      top: 16px;
    }
    .activity-item.green::before { background: #10b981; }
    .activity-item.yellow::before { background: #f59e0b; }
    .activity-item.blue::before { background: #3b82f6; }
    .activity-item.purple::before { background: #8b5cf6; }
    .activity-text { font-size: 13px; }
    .activity-time { font-size: 11px; color: #666; margin-top: 4px; }
    
    .funnel-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .funnel-bar {
      flex: 1;
      height: 24px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      overflow: hidden;
    }
    .funnel-fill {
      height: 100%;
      background: linear-gradient(90deg, #e63946, #f97316);
      transition: width 0.5s ease;
    }
    .funnel-label { width: 140px; font-size: 13px; }
    .funnel-value { width: 80px; text-align: right; font-weight: 600; }
    .funnel-pct { width: 60px; text-align: right; color: #888; font-size: 12px; }
    
    .gap-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .gap-skill { width: 120px; font-size: 13px; font-weight: 500; }
    .gap-bars { flex: 1; display: flex; gap: 8px; }
    .gap-bar {
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      min-width: 30px;
    }
    .gap-bar.demand { background: rgba(239,68,68,0.3); color: #ef4444; }
    .gap-bar.supply { background: rgba(16,185,129,0.3); color: #10b981; }
    .gap-status { width: 80px; text-align: right; }
    
    .note-item {
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .note-text { font-size: 13px; margin-bottom: 6px; }
    .note-time { font-size: 11px; color: #666; }
    
    .tag {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(59,130,246,0.15);
      color: #3b82f6;
      border-radius: 20px;
      font-size: 11px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .tag.vip { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .tag.verified { background: rgba(16,185,129,0.15); color: #10b981; }
    
    .verification {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
    }
    .verification.phone { background: rgba(128,128,128,0.15); color: #888; }
    .verification.profile { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .verification.work { background: rgba(139,92,246,0.15); color: #8b5cf6; }
    .verification.trusted { background: rgba(16,185,129,0.15); color: #10b981; }
    .verification.vip { background: rgba(245,158,11,0.15); color: #f59e0b; }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <form class="login-box" onsubmit="handleLogin(event)">
      <h1>TITLI</h1>
      <p>Command Center</p>
      <input type="password" id="password" placeholder="Enter password" required>
      <button type="submit">Enter</button>
    </form>
  </div>
  
  <div class="dashboard" id="dashboard">
    <header>
      <div><span class="logo">TITLI<span>Command Center</span></span></div>
      <div class="header-actions">
        <span class="last-updated" id="lastUpdated"></span>
        <button onclick="fetchAllData()">Refresh</button>
        <button class="logout" onclick="logout()">Logout</button>
      </div>
    </header>
    
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card blue" onclick="switchTab('users')">
          <div class="stat-value" id="statUsers">0</div>
          <div class="stat-label">Total Users</div>
          <div class="stat-detail" id="statUsersDetail">-</div>
        </div>
        <div class="stat-card green" onclick="switchTab('connections')">
          <div class="stat-value" id="statConnections">0</div>
          <div class="stat-label">Connections</div>
          <div class="stat-detail">Successful matches</div>
        </div>
        <div class="stat-card purple" onclick="switchTab('requests')">
          <div class="stat-value" id="statRequests">0</div>
          <div class="stat-label">Total Requests</div>
          <div class="stat-detail" id="statRequestsDetail">-</div>
        </div>
        <div class="stat-card yellow" onclick="switchTab('unfilled')">
          <div class="stat-value" id="statUnfilled">0</div>
          <div class="stat-label">Need Matches</div>
          <div class="stat-detail">Recruitment opportunities</div>
        </div>
        <div class="stat-card cyan" onclick="switchTab('recruitment')">
          <div class="stat-value" id="statRecruitment">0</div>
          <div class="stat-label">Recruiting</div>
          <div class="stat-detail" id="statRecruitmentDetail">-</div>
        </div>
        <div class="stat-card red" onclick="switchTab('activity')">
          <div class="stat-value" id="statActivity">0</div>
          <div class="stat-label">Actions Today</div>
          <div class="stat-detail">Taj activity</div>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="activity">Activity Feed</button>
        <button class="tab" data-tab="users">Users</button>
        <button class="tab" data-tab="requests">Requests</button>
        <button class="tab" data-tab="unfilled">Unfilled <span class="badge" id="unfilledBadge">0</span></button>
        <button class="tab" data-tab="connections">Connections</button>
        <button class="tab" data-tab="analytics">Analytics</button>
        <button class="tab" data-tab="skill-gaps">Skill Gaps</button>
        <button class="tab" data-tab="recruitment">Recruitment</button>
        <button class="tab" data-tab="external">External Opps</button>
      </div>
      
      <div class="toolbar">
        <input type="text" class="search" placeholder="Search users, requests, skills..." oninput="handleSearch(this.value)">
        <select id="statusFilter" onchange="handleStatusFilter(this.value)" style="padding:8px 12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:12px;">
          <option value="all">All Users</option>
          <option value="telegram">üì± On Telegram</option>
          <option value="complete">‚úì Complete+</option>
          <option value="verified">üíº Verified+</option>
          <option value="proven">‚≠ê Proven+</option>
          <option value="vip">üëë VIP Only</option>
        </select>
      </div>
      
      <div class="tab-content active" id="tab-overview">
        <div class="grid-3">
          <div class="card">
            <div class="card-header">Taj Activity (Last 24h)</div>
            <div id="recentActivity"><div class="loading">Loading...</div></div>
          </div>
          <div class="card highlight">
            <div class="card-header">Needs Your Attention <span class="count" id="attentionCount">0</span></div>
            <div id="needsAttention"><div class="loading">Loading...</div></div>
          </div>
          <div class="card">
            <div class="card-header">Conversion Funnel</div>
            <div id="quickFunnel"><div class="loading">Loading...</div></div>
          </div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header">Recent Users <span class="count" id="recentUsersCount">0</span></div>
            <div id="recentUsers"><div class="loading">Loading...</div></div>
          </div>
          <div class="card highlight">
            <div class="card-header">Top Skill Gaps <span class="count">Demand vs Supply</span></div>
            <div id="skillGapsSummary"><div class="loading">Loading...</div></div>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="tab-activity">
        <div class="card"><div class="card-header">All Taj Activity <span class="count" id="activityCount">0</span></div><div id="allActivity"><div class="loading">Loading...</div></div></div>
      </div>
      
      <div class="tab-content" id="tab-users">
        <div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
          <span>All Users <span class="count" id="userCount">0</span></span>
          <select id="userStatusFilter" onchange="handleUserStatusFilter(this.value)" style="padding:6px 10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:12px;">
            <option value="active">Active Users</option>
            <option value="all">All Users</option>
            <option value="blacklisted">Blacklisted Only</option>
          </select>
        </div><div id="allUsers"><div class="loading">Loading...</div></div></div>
      </div>
      
      <div class="tab-content" id="tab-requests">
        <div class="card"><div class="card-header">All Requests <span class="count" id="requestCount">0</span></div><div id="allRequests"><div class="loading">Loading...</div></div></div>
      </div>
      
      <div class="tab-content" id="tab-unfilled">
        <div class="card highlight"><div class="card-header">Recruitment Opportunities</div><div id="allUnfilled"><div class="loading">Loading...</div></div></div>
      </div>
      
      <div class="tab-content" id="tab-connections">
        <div class="card success"><div class="card-header">Successful Connections <span class="count" id="connectionCount">0</span></div><div id="allConnections"><div class="loading">Loading...</div></div></div>
      </div>
      
      <div class="tab-content" id="tab-analytics">
        <div class="grid-2">
          <div class="card"><div class="card-header">Conversion Funnel</div><div id="funnelChart"><div class="loading">Loading...</div></div></div>
          <div class="card"><div class="card-header">Growth (Last 30 Days)</div><div id="growthChart"><div class="loading">Loading...</div></div></div>
        </div>
      </div>
      
      <div class="tab-content" id="tab-skill-gaps">
        <div class="grid-2">
          <div class="card highlight"><div class="card-header">Skills Gap Analysis</div><div id="skillGapsAll"><div class="loading">Loading...</div></div></div>
          <div class="card"><div class="card-header">Available Skills</div><div id="availableSkills"><div class="loading">Loading...</div></div></div>
        </div>
      </div>
      
      <div class="tab-content" id="tab-recruitment">
        <div class="card">
          <div class="card-header">Recruitment Pipeline 
            <div style="display:flex;gap:8px;">
              <button class="action-btn secondary" onclick="getRecruitmentSuggestions()" style="padding:6px 12px;font-size:11px;">ü§ñ AI Suggestions</button>
              <button class="action-btn primary" onclick="showRecruitmentForm()" style="padding:6px 12px;font-size:11px;">+ Add Target</button>
            </div>
          </div>
          <div id="recruitmentSuggestions" style="display:none;padding:16px;background:rgba(139,92,246,0.1);border-bottom:1px solid rgba(139,92,246,0.3);"></div>
          <div id="recruitmentForm" style="display:none;padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);">
            <div class="form-inline">
              <div class="form-row"><label>Name</label><input type="text" id="recruitName" placeholder="Person's name"></div>
              <div class="form-row"><label>Platform</label><select id="recruitPlatform"><option value="instagram">Instagram</option><option value="linkedin">LinkedIn</option><option value="twitter">Twitter/X</option><option value="other">Other</option></select></div>
            </div>
            <div class="form-row"><label>Profile URL</label><input type="text" id="recruitUrl" placeholder="https://instagram.com/..."></div>
            <div class="form-inline">
              <div class="form-row"><label>Skills (comma separated)</label><input type="text" id="recruitSkills" placeholder="Photography, Videography"></div>
              <div class="form-row"><label>Location</label><input type="text" id="recruitLocation" placeholder="Austin, TX"></div>
            </div>
            <div class="form-row"><label>Notes</label><input type="text" id="recruitNotes" placeholder="Optional notes"></div>
            <button class="action-btn primary" onclick="saveRecruitmentTarget()" style="width:100%;margin-top:8px;">Save Target</button>
          </div>
          <div id="allRecruitment"><div class="loading">Loading...</div></div>
        </div>
      </div>
      
      <div class="tab-content" id="tab-external">
        <div class="card">
          <div class="card-header">External Opportunities 
            <div style="display:flex;gap:8px;">
              <button class="action-btn secondary" onclick="scrapeReddit()" style="padding:6px 12px;font-size:11px;">üîç Scrape Reddit</button>
              <button class="action-btn secondary" onclick="analyzeJobs()" style="padding:6px 12px;font-size:11px;">ü§ñ Analyze All</button>
              <button class="action-btn primary" onclick="showExternalForm()" style="padding:6px 12px;font-size:11px;">+ Add Opportunity</button>
            </div>
          </div>
          <div id="scrapeStatus" style="display:none;padding:12px;background:rgba(59,130,246,0.1);border-bottom:1px solid rgba(59,130,246,0.3);color:#60a5fa;"></div>
          <div id="externalForm" style="display:none;padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);">
            <div class="form-inline">
              <div class="form-row"><label>Source</label><input type="text" id="extSource" placeholder="Instagram, Craigslist, etc."></div>
              <div class="form-row"><label>Title</label><input type="text" id="extTitle" placeholder="Looking for photographer..."></div>
            </div>
            <div class="form-row"><label>Description</label><textarea id="extDescription" placeholder="Job details..."></textarea></div>
            <div class="form-inline">
              <div class="form-row"><label>Skills Needed</label><input type="text" id="extSkills" placeholder="Photography, Editing"></div>
              <div class="form-row"><label>Location</label><input type="text" id="extLocation" placeholder="Austin, TX"></div>
            </div>
            <div class="form-inline">
              <div class="form-row"><label>Budget</label><input type="text" id="extBudget" placeholder="$500/day"></div>
              <div class="form-row"><label>URL</label><input type="text" id="extUrl" placeholder="Link to original post"></div>
            </div>
            <button class="action-btn primary" onclick="saveExternalOpp()" style="width:100%;margin-top:8px;">Save Opportunity</button>
          </div>
          <div id="allExternal"><div class="loading">Loading...</div></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalUserName">User Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalUserBody"></div>
    </div>
  </div>

  <script>
    const API = "https://titly-backend-production.up.railway.app/api";
    const PASSWORD = "titli2024";
    
    let users = [], requests = [], unfilled = [], matches = [], connections = [], activity = [];
    let recruitmentTargets = [], externalOpps = [];
    let funnel = {}, skillGaps = {}, growth = {};
    let searchTerm = "";
    let statusFilter = 'all'; // all, telegram, complete, verified, proven, vip
    let userStatusFilter = 'active'; // 'active', 'all', 'blacklisted' - for Users tab only
    
    if (localStorage.getItem("titli_admin") === "true") { 
      showDashboard(); 
      fetchAllData(); 
      setInterval(fetchAllData, 30000);
      // Restore tab from URL hash
      const hash = window.location.hash.replace('#', '');
      if (hash) switchTab(hash);
    }
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
        // Save to URL hash
        window.location.hash = tab.dataset.tab;
      });
    });
    
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      const tabEl = document.querySelector(`[data-tab="${tabId}"]`);
      if (tabEl) {
        tabEl.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
        window.location.hash = tabId;
      }
    }
    
    function handleLogin(e) {
      e.preventDefault();
      if (document.getElementById("password").value === PASSWORD) {
        localStorage.setItem("titli_admin", "true");
        showDashboard(); fetchAllData(); setInterval(fetchAllData, 30000);
        const hash = window.location.hash.replace('#', '');
        if (hash) switchTab(hash);
      } else { alert("Wrong password"); }
    }
    
    function logout() { localStorage.removeItem("titli_admin"); location.reload(); }
    function showDashboard() { document.getElementById("loginScreen").style.display = "none"; document.getElementById("dashboard").classList.add("active"); }
    
    async function fetchAllData() {
      try {
        const [u, r, uf, m, c, a, rt, eo, f, sg, g] = await Promise.all([
          fetch(`${API}/admin/users`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/requests`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/unfilled-requests`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/matches`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/connections`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/activity?limit=100`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/recruitment/targets`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/opportunities/external`).then(res => res.json()).catch(() => []),
          fetch(`${API}/admin/analytics/funnel`).then(res => res.json()).catch(() => ({})),
          fetch(`${API}/admin/analytics/skill-gaps`).then(res => res.json()).catch(() => ({})),
          fetch(`${API}/admin/analytics/growth`).then(res => res.json()).catch(() => ({}))
        ]);
        users = u || []; requests = r || []; unfilled = uf || []; matches = m || []; connections = c || [];
        activity = a || []; recruitmentTargets = rt || []; externalOpps = eo || [];
        funnel = f || {}; skillGaps = sg || {}; growth = g || {};
        updateStats(); render();
        document.getElementById("lastUpdated").textContent = `Updated: ${new Date().toLocaleTimeString()}`;
      } catch (e) { console.error("Fetch error:", e); }
    }
    
    function updateStats() {
      const telegramUsers = users.filter(u => u.telegram_connected).length;
      const todayActivity = activity.filter(a => new Date(a.timestamp).toDateString() === new Date().toDateString()).length;
      const pendingRecruitment = recruitmentTargets.filter(t => t.status === 'found' || t.status === 'contacted').length;
      
      document.getElementById("statUsers").textContent = users.length;
      document.getElementById("statUsersDetail").textContent = `${telegramUsers} on Telegram`;
      document.getElementById("statConnections").textContent = connections.length;
      document.getElementById("statRequests").textContent = requests.length;
      document.getElementById("statRequestsDetail").textContent = `${requests.filter(r => r.status === 'completed').length} completed`;
      document.getElementById("statUnfilled").textContent = unfilled.length;
      document.getElementById("statRecruitment").textContent = recruitmentTargets.length;
      document.getElementById("statRecruitmentDetail").textContent = `${pendingRecruitment} in progress`;
      document.getElementById("statActivity").textContent = todayActivity;
      document.getElementById("unfilledBadge").textContent = unfilled.length;
      document.getElementById("attentionCount").textContent = unfilled.length + " items";
    }
    
    function handleSearch(term) { searchTerm = term.toLowerCase(); render(); }
    function handleStatusFilter(value) { statusFilter = value; render(); }
    
    const verificationOrder = ['unverified', 'phone', 'profile', 'work', 'trusted', 'vip'];
    function getVerificationLevel(level) { return verificationOrder.indexOf(level || 'phone'); }
    
    function getFilteredUsers() {
      return users.filter(u => {
        const matchesSearch = !searchTerm || u.name?.toLowerCase().includes(searchTerm) || u.phone?.includes(searchTerm) || u.skills?.some(s => s.toLowerCase().includes(searchTerm));
        
        // Status filter from toolbar dropdown
        let matchesStatusFilter = true;
        const level = getVerificationLevel(u.verification_level);
        if (statusFilter === 'telegram') matchesStatusFilter = u.telegram_connected;
        else if (statusFilter === 'complete') matchesStatusFilter = level >= 2; // profile+
        else if (statusFilter === 'verified') matchesStatusFilter = level >= 3; // work+
        else if (statusFilter === 'proven') matchesStatusFilter = level >= 4; // trusted+
        else if (statusFilter === 'vip') matchesStatusFilter = level >= 5; // vip only
        
        // User tab blacklist filter
        let matchesBlacklist = true;
        if (userStatusFilter === 'active') matchesBlacklist = u.blacklisted !== true;
        else if (userStatusFilter === 'blacklisted') matchesBlacklist = u.blacklisted === true;
        
        return matchesSearch && matchesStatusFilter && matchesBlacklist;
      });
    }
    
    function handleUserStatusFilter(value) { userStatusFilter = value; render(); }
    
    function render() {
      const filteredUsers = getFilteredUsers();
      
      document.getElementById("recentActivity").innerHTML = activity.length === 0 ? '<div class="empty">No activity yet</div>' : activity.slice(0, 10).map(a => activityItem(a)).join("");
      document.getElementById("needsAttention").innerHTML = unfilled.length === 0 ? '<div class="empty">All requests have matches!</div>' : unfilled.slice(0, 5).map(r => unfilledCard(r, true)).join("");
      
      if (funnel.funnel) {
        document.getElementById("quickFunnel").innerHTML = funnel.funnel.slice(0, 5).map(f => `<div class="funnel-item"><div class="funnel-label">${f.stage}</div><div class="funnel-bar"><div class="funnel-fill" style="width:${f.percentage}%"></div></div><div class="funnel-value">${f.count}</div><div class="funnel-pct">${f.percentage}%</div></div>`).join("");
      }
      
      document.getElementById("recentUsersCount").textContent = users.length;
      document.getElementById("recentUsers").innerHTML = users.length === 0 ? '<div class="empty">No users yet</div>' : users.slice(0, 5).map(u => userCard(u)).join("");
      
      if (skillGaps.skill_gaps) {
        document.getElementById("skillGapsSummary").innerHTML = skillGaps.skill_gaps.slice(0, 5).map(g => `<div class="gap-item"><div class="gap-skill">${g.skill}</div><div class="gap-bars"><div class="gap-bar demand" style="width:${Math.min(g.demand * 30, 100)}px">${g.demand} need</div><div class="gap-bar supply" style="width:${Math.min(g.supply * 30, 100)}px">${g.supply} have</div></div><div class="gap-status">${g.gap > 0 ? `<span class="badge red">-${g.gap}</span>` : `<span class="badge green">+${Math.abs(g.gap)}</span>`}</div></div>`).join("");
      }
      
      document.getElementById("activityCount").textContent = activity.length;
      document.getElementById("allActivity").innerHTML = activity.length === 0 ? '<div class="empty">No activity yet</div>' : activity.map(a => activityItem(a)).join("");
      
      document.getElementById("userCount").textContent = filteredUsers.length;
      document.getElementById("allUsers").innerHTML = filteredUsers.length === 0 ? '<div class="empty">No users found</div>' : filteredUsers.map(u => userCard(u, true)).join("");
      
      document.getElementById("requestCount").textContent = requests.length;
      document.getElementById("allRequests").innerHTML = requests.length === 0 ? '<div class="empty">No requests yet</div>' : requests.map(r => requestCard(r)).join("");
      
      document.getElementById("allUnfilled").innerHTML = unfilled.length === 0 ? '<div class="empty">All requests have matches!</div>' : unfilled.map(r => unfilledCard(r)).join("");
      
      document.getElementById("connectionCount").textContent = connections.length;
      document.getElementById("allConnections").innerHTML = connections.length === 0 ? '<div class="empty">No connections yet</div>' : connections.map(c => connectionCard(c)).join("");
      
      if (funnel.funnel) { document.getElementById("funnelChart").innerHTML = funnel.funnel.map(f => `<div class="funnel-item"><div class="funnel-label">${f.stage}</div><div class="funnel-bar"><div class="funnel-fill" style="width:${f.percentage}%"></div></div><div class="funnel-value">${f.count}</div><div class="funnel-pct">${f.percentage}%</div></div>`).join(""); }
      
      if (growth.totals) {
        document.getElementById("growthChart").innerHTML = `<div style="padding:20px"><div style="display:flex;justify-content:space-around;text-align:center"><div><div style="font-size:32px;font-weight:700;color:#3b82f6">${growth.totals.users}</div><div style="font-size:12px;color:#888">Total Users</div></div><div><div style="font-size:32px;font-weight:700;color:#8b5cf6">${growth.totals.requests}</div><div style="font-size:12px;color:#888">Total Requests</div></div><div><div style="font-size:32px;font-weight:700;color:#10b981">${growth.totals.connections}</div><div style="font-size:12px;color:#888">Connections</div></div></div>${growth.this_week ? `<div style="margin-top:20px;text-align:center"><div style="font-size:14px;color:#888">This Week</div><div style="font-size:24px;font-weight:600">${growth.this_week.users} new users ${growth.this_week.change > 0 ? `<span style="color:#10b981">‚Üë${growth.this_week.change}</span>` : growth.this_week.change < 0 ? `<span style="color:#ef4444">‚Üì${Math.abs(growth.this_week.change)}</span>` : ''}</div></div>` : ''}</div>`;
      }
      
      if (skillGaps.skill_gaps) { document.getElementById("skillGapsAll").innerHTML = skillGaps.skill_gaps.map(g => `<div class="gap-item"><div class="gap-skill">${g.skill}</div><div class="gap-bars"><div class="gap-bar demand" style="width:${Math.min(g.demand * 30, 100)}px">${g.demand} need</div><div class="gap-bar supply" style="width:${Math.min(g.supply * 30, 100)}px">${g.supply} have</div></div><div class="gap-status">${g.gap > 0 ? `<span class="badge red">-${g.gap}</span>` : `<span class="badge green">+${Math.abs(g.gap)}</span>`}</div></div>`).join(""); }
      if (skillGaps.available_skills) { document.getElementById("availableSkills").innerHTML = `<div style="padding:16px">${Object.entries(skillGaps.available_skills).map(([skill, count]) => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)"><span>${skill}</span><span class="badge purple">${count} users</span></div>`).join("")}</div>`; }
      
      document.getElementById("allRecruitment").innerHTML = recruitmentTargets.length === 0 ? '<div class="empty">No recruitment targets yet</div>' : recruitmentTargets.map(t => recruitmentCard(t)).join("");
      document.getElementById("allExternal").innerHTML = externalOpps.length === 0 ? '<div class="empty">No external opportunities yet</div>' : externalOpps.map(o => externalCard(o)).join("");
    }
    
    function activityItem(a) {
      const colors = { 'user_signup': 'blue', 'profile_completed': 'green', 'telegram_connected': 'cyan', 'request_created': 'purple', 'matches_found': 'yellow', 'outreach_sent': 'red', 'connection_made': 'green' };
      const icons = { 'user_signup': 'üë§', 'profile_completed': '‚úì', 'telegram_connected': 'üì±', 'request_created': 'üìã', 'matches_found': 'üîç', 'outreach_sent': 'üì§', 'connection_made': 'ü§ù', 'profile_enriched': '‚ú®' };
      let text = a.action.replace(/_/g, ' ');
      if (a.details) { if (a.details.name) text += `: ${a.details.name}`; if (a.details.title) text += `: ${a.details.title}`; if (a.details.matches_count) text += ` (${a.details.matches_count} matches)`; }
      return `<div class="activity-item ${colors[a.action] || ''}"><div class="activity-text">${icons[a.action] || '‚Ä¢'} ${text}</div><div class="activity-time">${timeAgo(a.timestamp)}</div></div>`;
    }
    
    function userCard(u, detailed = false) {
      const verificationTiers = {
        unverified: { icon: '‚ö™', color: '#666' },
        phone: { icon: 'üì±', color: '#3b82f6' },
        profile: { icon: '‚úì', color: '#10b981' },
        work: { icon: 'üíº', color: '#8b5cf6' },
        trusted: { icon: '‚≠ê', color: '#f59e0b' },
        vip: { icon: 'üëë', color: '#ec4899' }
      };
      const tier = verificationTiers[u.verification_level] || verificationTiers.phone;
      const blacklistBadge = u.blacklisted ? '<span class="badge" style="background:rgba(239,68,68,0.2);color:#ef4444;">‚õî Blacklisted</span>' : '';
      return `<div class="item-card" onclick="showUserDetail('${u.id}')" ${u.blacklisted ? 'style="opacity:0.6;border-color:rgba(239,68,68,0.3);"' : ''}><div class="item-header"><div class="avatar">${u.name?.charAt(0) || "?"}</div><div class="item-info"><div class="item-name">${u.name || "Unknown"} <span style="color:${tier.color};font-size:12px;">${tier.icon}</span></div><div class="item-sub">${u.phone || ""} ${u.location ? `‚Ä¢ ${u.location}` : ''}</div></div>${blacklistBadge}${u.telegram_connected && !u.blacklisted ? '<span class="badge green">Telegram</span>' : ''}</div>${u.tags?.length ? `<div class="item-meta">${u.tags.map(t => `<span class="tag ${t.toLowerCase() === 'vip' ? 'vip' : ''}">${t}</span>`).join("")}</div>` : ''}<div class="item-meta">${(u.skills || []).slice(0, detailed ? 6 : 3).map(s => `<span class="skill-tag">${s}</span>`).join("")}</div></div>`;
    }
    
    function requestCard(r) {
      const colors = { 'in_progress': 'yellow', 'awaiting_approval': 'purple', 'matching': 'blue', 'completed': 'green', 'cancelled': 'gray' };
      const user = users.find(u => u.id === r.user_id);
      return `<div class="item-card"><div style="display:flex;justify-content:space-between;align-items:start"><div><div class="item-name">${r.title || "Untitled"}</div><div class="item-sub">By ${user?.name || 'Unknown'} ‚Ä¢ ${timeAgo(r.created_at)}</div></div><span class="badge ${colors[r.status] || 'gray'}">${r.status?.replace('_', ' ')}</span></div></div>`;
    }
    
    function unfilledCard(r, compact = false) {
      const searchTerm = encodeURIComponent(r.title || "");
      return `<div class="item-card" style="border-left:3px solid #f59e0b"><div class="item-name" style="color:#fbbf24">${r.title || "Untitled"}</div><div class="item-sub">By ${r.requester || 'Unknown'} ‚Ä¢ ${timeAgo(r.created_at)}</div>${!compact ? `<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap"><a href="https://www.instagram.com/explore/search/keyword/?q=${searchTerm}" target="_blank" class="action-btn ig">Find on IG</a><a href="https://www.linkedin.com/search/results/people/?keywords=${searchTerm}" target="_blank" class="action-btn li">Find on LinkedIn</a></div>` : ''}</div>`;
    }
    
    function connectionCard(c) {
      return `<div class="item-card"><div style="display:flex;align-items:center;gap:12px"><div class="avatar" style="width:32px;height:32px;font-size:12px">${c.user_1?.name?.charAt(0) || "?"}</div><span style="color:#10b981">ü§ù</span><div class="avatar" style="width:32px;height:32px;font-size:12px">${c.user_2?.name?.charAt(0) || "?"}</div><div><div class="item-name">${c.user_1?.name || 'Unknown'} ‚Üî ${c.user_2?.name || 'Unknown'}</div><div class="item-sub">${c.request?.title || ''} ‚Ä¢ ${timeAgo(c.created_at)}</div></div></div></div>`;
    }
    
    function recruitmentCard(t) {
      const colors = { 'found': 'blue', 'contacted': 'yellow', 'responded': 'purple', 'joined': 'green', 'declined': 'red' };
      return `<div class="item-card"><div style="display:flex;justify-content:space-between;align-items:start"><div><div class="item-name">${t.name}</div><div class="item-sub">${t.platform} ‚Ä¢ <a href="${t.profile_url}" target="_blank" style="color:#3b82f6">View Profile</a></div>${t.skills_detected?.length ? `<div class="item-meta" style="margin-top:8px">${t.skills_detected.map(s => `<span class="skill-tag">${s}</span>`).join("")}</div>` : ''}${t.location ? `<div class="item-sub" style="margin-top:4px">üìç ${t.location}</div>` : ''}</div><span class="badge ${colors[t.status]}">${t.status}</span></div><div style="margin-top:12px;display:flex;gap:8px">${t.status === 'found' ? `<button class="action-btn secondary" onclick="updateRecruitment('${t.id}', 'contacted')">Mark Contacted</button>` : ''}${t.status === 'contacted' ? `<button class="action-btn secondary" onclick="updateRecruitment('${t.id}', 'responded')">Mark Responded</button>` : ''}${t.status !== 'joined' && t.status !== 'declined' ? `<button class="action-btn green" onclick="updateRecruitment('${t.id}', 'joined')">Joined</button><button class="action-btn secondary" onclick="updateRecruitment('${t.id}', 'declined')">Declined</button>` : ''}</div></div>`;
    }
    
    function externalCard(o) {
      const colors = { 'new': 'blue', 'sent': 'yellow', 'accepted': 'green', 'expired': 'gray' };
      const matchCount = o.matched_users?.length || 0;
      return `<div class="item-card">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <div class="item-name">${o.title}</div>
            <div class="item-sub">${o.source} ${o.location ? `‚Ä¢ ${o.location}` : ''} ${o.budget ? `‚Ä¢ ${o.budget}` : ''}</div>
            ${o.skills_needed?.length ? `<div class="item-meta" style="margin-top:8px">${o.skills_needed.map(s => `<span class="skill-tag">${s}</span>`).join("")}</div>` : ''}
            ${o.analyzed ? '<span style="font-size:10px;color:#a78bfa;">‚úì AI Analyzed</span>' : ''}
          </div>
          <span class="badge ${colors[o.status] || 'gray'}">${o.status}</span>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          ${o.url ? `<a href="${o.url}" target="_blank" style="color:#3b82f6;font-size:12px;">View original ‚Üí</a>` : ''}
          <button class="action-btn secondary" onclick="matchExternalOpp('${o.id}')" style="padding:4px 10px;font-size:11px;">üîç Find Matches ${matchCount > 0 ? `(${matchCount})` : ''}</button>
          ${o.status === 'new' ? `<button class="action-btn green" onclick="updateExternalStatus('${o.id}', 'sent')" style="padding:4px 10px;font-size:11px;">Mark Sent</button>` : ''}
        </div>
      </div>`;
    }
    
    function showUserDetail(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;
      document.getElementById("modalUserName").textContent = user.name || "User Details";
      const verificationTiers = {
        unverified: { icon: '‚ö™', name: 'New', color: '#666' },
        phone: { icon: 'üì±', name: 'Signed Up', color: '#3b82f6' },
        profile: { icon: '‚úì', name: 'Complete', color: '#10b981' },
        work: { icon: 'üíº', name: 'Verified', color: '#8b5cf6' },
        trusted: { icon: '‚≠ê', name: 'Proven', color: '#f59e0b' },
        vip: { icon: 'üëë', name: 'VIP', color: '#ec4899' }
      };
      const currentTier = verificationTiers[user.verification_level || 'phone'] || verificationTiers.phone;
      const social = user.social_links || {};
      
      const ep = user.enriched_profile || {};
      const hasConvoData = ep.budget_range || ep.availability || ep.industries?.length || ep.work_types?.length;
      const hasSocialData = ep.summary || ep.credibility_score;
      
      let html = `<div class="modal-section"><h3>Contact & Status</h3><p>üì± ${user.phone || 'No phone'}</p><p>üìç ${user.location || 'No location'}</p>${user.telegram_connected ? '<p style="color:#10b981">‚úì Telegram Connected</p>' : '<p style="color:#888">‚úó Not on Telegram</p>'}<p>Status: <span style="color:${currentTier.color};font-weight:600">${currentTier.icon} ${currentTier.name}</span></p></div>
      
      <div class="modal-section"><h3>Social Links</h3>
        ${social.instagram ? `<p><a href="${social.instagram.startsWith('http') ? social.instagram : 'https://' + social.instagram}" target="_blank" style="color:#ec4899;">üì∏ Instagram ‚Üí</a></p>` : ''}
        ${social.linkedin ? `<p><a href="${social.linkedin.startsWith('http') ? social.linkedin : 'https://' + social.linkedin}" target="_blank" style="color:#3b82f6;">üíº LinkedIn ‚Üí</a></p>` : ''}
        ${social.imdb ? `<p><a href="${social.imdb.startsWith('http') ? social.imdb : 'https://' + social.imdb}" target="_blank" style="color:#f59e0b;">üé¨ IMDb ‚Üí</a></p>` : ''}
        ${social.twitter ? `<p><a href="${social.twitter.startsWith('http') ? social.twitter : 'https://' + social.twitter}" target="_blank" style="color:#1da1f2;">üê¶ Twitter ‚Üí</a></p>` : ''}
        ${social.soundcloud ? `<p><a href="${social.soundcloud.startsWith('http') ? social.soundcloud : 'https://' + social.soundcloud}" target="_blank" style="color:#ff5500;">üéµ SoundCloud ‚Üí</a></p>` : ''}
        ${!social.instagram && !social.linkedin && !social.imdb && !social.twitter && !social.soundcloud ? '<p style="color:#666">No social links</p>' : ''}
      </div>
      
      <!-- CONVERSATION INTELLIGENCE - from Taj chats -->
      ${hasConvoData ? `<div class="modal-section" style="background:linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(59,130,246,0.1) 100%);padding:16px;border-radius:10px;border:1px solid rgba(16,185,129,0.3)">
        <h3 style="color:#10b981;margin-bottom:12px;">üí¨ From Conversations</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          ${ep.budget_range ? `<div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;"><span style="font-size:11px;color:#888;">üí∞ Budget</span><br><strong style="color:#fff;">${ep.budget_range}</strong></div>` : ''}
          ${ep.availability ? `<div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;"><span style="font-size:11px;color:#888;">üìÖ Availability</span><br><strong style="color:#fff;">${ep.availability}</strong></div>` : ''}
        </div>
        ${ep.industries?.length ? `<p style="margin-top:8px;"><span style="color:#888;">üè¢ Industries:</span> ${ep.industries.join(', ')}</p>` : ''}
        ${ep.work_types?.length ? `<p><span style="color:#888;">üé¨ Work Types:</span> ${ep.work_types.join(', ')}</p>` : ''}
        ${ep.looking_for ? `<p><span style="color:#888;">üîç Looking for:</span> ${ep.looking_for}</p>` : ''}
        ${ep.offering ? `<p><span style="color:#888;">‚ú® Offering:</span> ${ep.offering}</p>` : ''}
        <p style="font-size:10px;color:#666;margin-top:8px;">Extracted from Telegram chats with Taj</p>
      </div>` : ''}
      
      <!-- SOCIAL PROFILE - from scraping (optional) -->
      ${hasSocialData ? `<div class="modal-section" style="background:linear-gradient(135deg, rgba(139,92,246,0.15) 0%, rgba(236,72,153,0.1) 100%);padding:16px;border-radius:10px;border:1px solid rgba(139,92,246,0.3)">
        <h3 style="color:#a78bfa;margin-bottom:12px;">üîç Social Profile</h3>
        ${ep.summary ? `<p style="margin-bottom:12px;font-style:italic;color:#e0e0e0;">"${ep.summary}"</p>` : ''}
        ${ep.credibility_score ? `<div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;display:inline-block;"><span style="font-size:11px;color:#888;">Credibility</span><br><strong style="font-size:18px;color:#10b981;">${ep.credibility_score}/100</strong></div>` : ''}
        ${ep.specialties?.length ? `<p style="margin-top:8px;"><span style="color:#888;">‚≠ê Specialties:</span> ${ep.specialties.join(', ')}</p>` : ''}
        ${ep.extracted_skills?.length ? `<p><span style="color:#888;">üõ† Skills Found:</span> ${ep.extracted_skills.join(', ')}</p>` : ''}
        <p style="font-size:10px;color:#666;margin-top:8px;text-align:right;">Updated ${ep.enriched_at ? timeAgo(ep.enriched_at) : 'Unknown'}</p>
      </div>` : ''}
      
      ${!hasConvoData && !hasSocialData ? `<div class="modal-section" style="background:rgba(255,255,255,0.03);padding:16px;border-radius:10px;border:1px dashed rgba(255,255,255,0.1);">
        <p style="color:#666;text-align:center;">ü§ñ No intel yet. Chat with Taj on Telegram to build profile.</p>
      </div>` : ''}
      
      ${user.blacklisted ? `<div class="modal-section" style="background:rgba(239,68,68,0.2);padding:12px;border-radius:8px;border:1px solid rgba(239,68,68,0.5)"><span style="color:#ef4444;font-weight:600">‚õî BLACKLISTED</span>${user.blacklist_reason ? `<p style="color:#fca5a5;margin-top:4px;font-size:13px">Reason: ${user.blacklist_reason}</p>` : ''}</div>` : ''}
      
      <div class="modal-section"><h3>Bio</h3><p>${user.bio || '<span style="color:#666">No bio</span>'}</p></div>
      
      <div class="modal-section"><h3>Skills (${user.skills?.length || 0})</h3><div style="display:flex;gap:6px;flex-wrap:wrap">${(user.skills || []).map(s => `<span class="skill-tag">${s}</span>`).join('') || '<span style="color:#666">No skills</span>'}</div></div>
      
      <div class="modal-section"><h3>Tags</h3><div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">${(user.tags || []).map(t => `<span class="tag">${t}</span>`).join("") || '<span style="color:#666">No tags</span>'}</div><div style="display:flex;gap:8px;margin-top:8px"><input type="text" id="newTag" placeholder="Add tag" style="flex:1;padding:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff"><button class="action-btn secondary" onclick="addTag('${user.id}')">Add</button></div></div>
      
      <div class="modal-section"><h3>Notes</h3><div id="userNotes">${(user.notes || []).map(n => `<div class="note-item"><div class="note-text">${n.note}</div><div class="note-time">${timeAgo(n.created_at)}</div></div>`).join("") || '<p style="color:#666">No notes</p>'}</div><div style="display:flex;gap:8px;margin-top:8px"><input type="text" id="newNote" placeholder="Add note" style="flex:1;padding:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff"><button class="action-btn secondary" onclick="addNote('${user.id}')">Add</button></div></div>
      
      <div class="modal-section"><h3>Send Telegram Message</h3>${user.telegram_connected ? `<div style="display:flex;gap:8px"><input type="text" id="telegramMsg" placeholder="Type message..." style="flex:1;padding:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff"><button class="action-btn primary" onclick="sendTelegramMessage('${user.id}')">Send</button></div>` : '<p style="color:#666">User not connected to Telegram</p>'}</div>
      
      <div class="modal-section"><h3>Actions</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <label style="font-size:12px;color:#888;">Set Status:</label>
          <select id="verificationSelect" onchange="setVerificationManual('${user.id}', this.value)" style="padding:6px 10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:12px;">
            <option value="" disabled selected>Change...</option>
            <option value="unverified" ${user.verification_level === 'unverified' ? 'disabled' : ''}>‚ö™ New</option>
            <option value="phone" ${user.verification_level === 'phone' ? 'disabled' : ''}>üì± Signed Up</option>
            <option value="profile" ${user.verification_level === 'profile' ? 'disabled' : ''}>‚úì Complete</option>
            <option value="work" ${user.verification_level === 'work' ? 'disabled' : ''}>üíº Verified</option>
            <option value="trusted" ${user.verification_level === 'trusted' ? 'disabled' : ''}>‚≠ê Proven</option>
            <option value="vip" ${user.verification_level === 'vip' ? 'disabled' : ''}>üëë VIP</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
          ${user.blacklisted ? `<button class="action-btn secondary" onclick="unblacklistUser('${user.id}')" style="background:rgba(34,197,94,0.2);color:#22c55e">Remove Blacklist</button>` : `<button class="action-btn secondary" onclick="blacklistUser('${user.id}')" style="background:rgba(239,68,68,0.2);color:#ef4444">Blacklist</button>`}
        </div>
      </div>`;
      
      document.getElementById("modalUserBody").innerHTML = html;
      document.getElementById("userModal").classList.add("active");
    }
    
    function closeModal() { document.getElementById("userModal").classList.remove("active"); }
    
    async function addTag(userId) { const tag = document.getElementById("newTag").value.trim(); if (!tag) return; await fetch(`${API}/admin/users/${userId}/tags?tag=${encodeURIComponent(tag)}`, { method: "POST" }); fetchAllData(); closeModal(); }
    async function addNote(userId) { const note = document.getElementById("newNote").value.trim(); if (!note) return; await fetch(`${API}/admin/users/${userId}/notes?note=${encodeURIComponent(note)}`, { method: "POST" }); fetchAllData(); showUserDetail(userId); }
    async function setVerificationManual(userId, level) { 
      if (!level) return;
      await fetch(`${API}/admin/users/${userId}/verification-manual?level=${level}`, { method: "PATCH" }); 
      fetchAllData(); 
      closeModal(); 
    }
    async function reanalyzeProfile(userId) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚è≥ Analyzing...';
      btn.disabled = true;
      
      try {
        const res = await fetch(`${API}/admin/users/${userId}/enrich`, { method: 'POST' });
        const data = await res.json();
        if (data.enriched) {
          alert('‚úÖ Profile analyzed by Taj!');
        } else {
          alert(`‚ö†Ô∏è ${data.reason || 'Could not analyze profile'}`);
          console.log('Enrich failed:', data);
        }
      } catch (e) {
        alert('Error analyzing profile: ' + e.message);
        console.error(e);
      }
      
      btn.textContent = originalText;
      btn.disabled = false;
      fetchAllData();
      setTimeout(() => showUserDetail(userId), 500);
    }
    async function blacklistUser(userId) { 
      const reason = prompt("Reason for blacklisting (optional):"); 
      if (reason === null) return; // Cancelled
      const params = reason ? `?reason=${encodeURIComponent(reason)}` : '';
      await fetch(`${API}/admin/users/${userId}/blacklist${params}`, { method: "PATCH" }); 
      fetchAllData(); 
      closeModal(); 
      alert("User blacklisted. They won't appear in any matches.");
    }
    async function unblacklistUser(userId) { 
      if (!confirm("Remove this user from blacklist?")) return;
      await fetch(`${API}/admin/users/${userId}/unblacklist`, { method: "PATCH" }); 
      fetchAllData(); 
      closeModal(); 
    }
    async function sendTelegramMessage(userId) { const msg = document.getElementById("telegramMsg").value.trim(); if (!msg) return; try { await fetch(`${API}/admin/users/${userId}/message?message=${encodeURIComponent(msg)}`, { method: "POST" }); alert("Message sent!"); } catch (e) { alert("Failed to send"); } }
    
    function showRecruitmentForm() { const f = document.getElementById("recruitmentForm"); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
    function showExternalForm() { const f = document.getElementById("externalForm"); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
    
    async function saveRecruitmentTarget() {
      const name = document.getElementById("recruitName").value;
      const platform = document.getElementById("recruitPlatform").value;
      const url = document.getElementById("recruitUrl").value;
      const skills = document.getElementById("recruitSkills").value;
      const location = document.getElementById("recruitLocation").value;
      const notes = document.getElementById("recruitNotes").value;
      if (!name || !url) { alert("Name and URL required"); return; }
      const params = new URLSearchParams({ name, platform, profile_url: url });
      if (skills) params.append("skills", skills);
      if (location) params.append("location", location);
      if (notes) params.append("notes", notes);
      await fetch(`${API}/admin/recruitment/targets?${params}`, { method: "POST" });
      document.getElementById("recruitmentForm").style.display = "none";
      fetchAllData();
    }
    
    async function updateRecruitment(id, status) { await fetch(`${API}/admin/recruitment/targets/${id}?status=${status}`, { method: "PATCH" }); fetchAllData(); }
    
    async function saveExternalOpp() {
      const source = document.getElementById("extSource").value;
      const title = document.getElementById("extTitle").value;
      const description = document.getElementById("extDescription").value;
      const skills = document.getElementById("extSkills").value;
      const location = document.getElementById("extLocation").value;
      const budget = document.getElementById("extBudget").value;
      const url = document.getElementById("extUrl").value;
      if (!source || !title) { alert("Source and Title required"); return; }
      const params = new URLSearchParams({ source, title });
      if (description) params.append("description", description);
      if (skills) params.append("skills_needed", skills);
      if (location) params.append("location", location);
      if (budget) params.append("budget", budget);
      if (url) params.append("url", url);
      await fetch(`${API}/admin/opportunities/external?${params}`, { method: "POST" });
      document.getElementById("externalForm").style.display = "none";
      fetchAllData();
    }
    
    function timeAgo(dateString) {
      if (!dateString) return '';
      const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      return new Date(dateString).toLocaleDateString();
    }
    
    // ============ SCRAPING & AI FUNCTIONS ============
    
    async function scrapeReddit() {
      const statusEl = document.getElementById("scrapeStatus");
      statusEl.style.display = "block";
      statusEl.innerHTML = "üîç Scraping Reddit for job posts... (this may take a moment)";
      
      try {
        const res = await fetch(`${API}/admin/scrape/reddit`, { method: "POST" });
        const data = await res.json();
        statusEl.innerHTML = `‚úÖ Found ${data.scraped || 0} new job posts from Reddit!`;
        fetchAllData();
        setTimeout(() => { statusEl.style.display = "none"; }, 5000);
      } catch (e) {
        statusEl.innerHTML = "‚ùå Scraping failed. Check server logs.";
        setTimeout(() => { statusEl.style.display = "none"; }, 5000);
      }
    }
    
    async function analyzeJobs() {
      const statusEl = document.getElementById("scrapeStatus");
      statusEl.style.display = "block";
      statusEl.innerHTML = "ü§ñ Analyzing jobs with AI...";
      
      try {
        const res = await fetch(`${API}/admin/scrape/analyze`, { method: "POST" });
        const data = await res.json();
        statusEl.innerHTML = `‚úÖ Analyzed ${data.analyzed || 0} jobs!`;
        fetchAllData();
        setTimeout(() => { statusEl.style.display = "none"; }, 5000);
      } catch (e) {
        statusEl.innerHTML = "‚ùå Analysis failed.";
        setTimeout(() => { statusEl.style.display = "none"; }, 5000);
      }
    }
    
    async function getRecruitmentSuggestions() {
      const suggestEl = document.getElementById("recruitmentSuggestions");
      suggestEl.style.display = "block";
      suggestEl.innerHTML = "ü§ñ Analyzing talent gaps and generating suggestions...";
      
      try {
        const res = await fetch(`${API}/admin/recruitment/suggestions`);
        const suggestions = await res.json();
        
        if (!suggestions || suggestions.length === 0) {
          suggestEl.innerHTML = `<div style="color:#a78bfa"><strong>No talent gaps detected!</strong><br><span style="color:#888">Everyone's needs are being met. Keep growing!</span></div>`;
          return;
        }
        
        let html = `<div style="margin-bottom:12px;color:#a78bfa;font-weight:600">üéØ AI Recruitment Suggestions (Based on Talent Gaps)</div>`;
        
        suggestions.forEach(s => {
          html += `
            <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <strong style="color:#fff;font-size:15px;">${s.skill_needed}</strong>
                  <span style="color:#888;margin-left:8px;">Demand: ${s.demand} | Supply: ${s.supply}</span>
                </div>
                <span class="badge yellow">High Priority</span>
              </div>
              <div style="margin-top:10px;font-size:12px;">
                <div style="color:#888;margin-bottom:6px;">Search queries:</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                  <span style="background:rgba(236,72,153,0.2);color:#ec4899;padding:4px 8px;border-radius:4px;font-size:11px;">IG: ${s.search_queries?.instagram || ''}</span>
                  <span style="background:rgba(59,130,246,0.2);color:#3b82f6;padding:4px 8px;border-radius:4px;font-size:11px;">LinkedIn: ${s.search_queries?.linkedin || ''}</span>
                  <span style="background:rgba(0,0,0,0.3);color:#888;padding:4px 8px;border-radius:4px;font-size:11px;">X: ${s.search_queries?.twitter || ''}</span>
                </div>
              </div>
              <div style="margin-top:10px;">
                <div style="color:#888;font-size:12px;margin-bottom:4px;">Outreach template:</div>
                <div style="background:rgba(255,255,255,0.05);padding:8px;border-radius:6px;font-size:12px;color:#ccc;cursor:pointer;" onclick="navigator.clipboard.writeText(this.innerText);alert('Copied!');">${s.outreach_template || ''}</div>
              </div>
            </div>
          `;
        });
        
        html += `<button class="action-btn secondary" onclick="document.getElementById('recruitmentSuggestions').style.display='none'" style="margin-top:8px;">Close</button>`;
        suggestEl.innerHTML = html;
        
      } catch (e) {
        suggestEl.innerHTML = "‚ùå Failed to get suggestions.";
      }
    }
    
    async function matchExternalOpp(oppId) {
      try {
        const res = await fetch(`${API}/admin/opportunities/external/${oppId}/match`, { method: "POST" });
        const data = await res.json();
        if (data.matches && data.matches.length > 0) {
          const names = data.matches.map(m => m.user?.name || 'Unknown').join(', ');
          alert(`Found ${data.matches.length} matches: ${names}`);
        } else {
          alert("No matches found for this opportunity.");
        }
        fetchAllData();
      } catch (e) {
        alert("Matching failed.");
      }
    }
    
    async function updateExternalStatus(oppId, status) {
      await fetch(`${API}/admin/opportunities/external/${oppId}?status=${status}`, { method: "PATCH" });
      fetchAllData();
    }
    
    document.getElementById("userModal").addEventListener("click", function(e) { if (e.target === this) closeModal(); });
  </script>
</body>
</html>
